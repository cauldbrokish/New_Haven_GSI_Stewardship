---
title: "New Haven GSI Stewardship"
author: "Clare Auld-Brokish (with Dexter Locke)"
date: "`r format(Sys.time())`"
output: html_document
editor_options: 
  chunk_output_type: console
---

# 0 set up
```{r}

# Load libraries 
packs <-c('tidyverse'   # cuz
          , 'tidylog'   # prints out what was done in dplyr and tidyr; VERBOSE
          # , 'tidygeocoder' # geocode addressses
          , 'tidycensus'   # access Census data
          , 'sf'           # for spatial data support
          , 'mapview'      # web maps for zooming and panning around
          , 'janitor'   # helps clean things pipe-friendly cross-tabulations
          )

if (length(setdiff(packs, rownames(installed.packages()))) > 0) {
  install.packages(setdiff(packs, rownames(installed.packages())))
}

# load the packages all at once
vapply(packs, library, character.only = TRUE, logical(1),
       logical.return = TRUE, quietly = TRUE)


```


# 1 read in data
## A Neighborhoods
```{r}

(neighs <- st_read('input_data/New_Haven_Neighborhoods/Neighborhood.shp'))


neighs |> mapview()
```


## B Parks
```{r}

(parks <- st_read('input_data/NewHavenParksLayers_08032021/NewHavenParks.shp'))

parks |> mapview()

parks |> mapview() + mapview(neighs)

```



## C GSI: URI
```{r}

# what's in the geodatabase?
st_layers('input_data/URI_Bioswale.gdb/')

(gsi_1 <- st_read('input_data/URI_Bioswale.gdb/' # path
                  , 'Bioswales_1' # data
                  , as_tibble = TRUE) |> 
    mutate(file = 'Bioswales_1')
  )


(gsi_2 <- st_read('input_data/URI_Bioswale.gdb/' # path
                  , 'Bioswales_DT_N' # data
                  , as_tibble = TRUE) |> 
    mutate(file = 'Bioswales_DT_N')
  )

(gsi_3 <- st_read('input_data/URI_Bioswale.gdb/' # path
                  , 'Bioswales_DT_S' # data
                  , as_tibble = TRUE) |> 
    mutate(file = 'Bioswales_DT_S')
  )

# Which columns are in common?
compare_df_cols(gsi_1, gsi_2, gsi_3)


# gsi_1 |> mapview()
# gsi_2 |> mapview()
# gsi_3 |> mapview()

# mapview(gsi_1) + mapview(gsi_2) + mapview(gsi_3) 

# att_tbl <- st_read('input_data/URI_Bioswale.gdb' # path
#                    , 'Bioswales_DT_S__ATTACH' # data
#                    , as_tibble = TRUE) 

gsi <- 
  bind_rows(gsi_1, gsi_2, gsi_3)

mapview(gsi, zcol = 'file')

```



## D GSI: City of New Haven
```{r}

list.files('../GSI STEWARDSHIP Project_data_too_big')

st_layers('../GSI STEWARDSHIP Project_data_too_big/50961b03-cb0b-49b9-a656-77d71bc30bbd.gdb')

inlet <- 
  st_read(  '../GSI STEWARDSHIP Project_data_too_big/50961b03-cb0b-49b9-a656-77d71bc30bbd.gdb'
          , 'inlet'
          , as_tibble = TRUE)

inspection <- 
  st_read(  '../GSI STEWARDSHIP Project_data_too_big/50961b03-cb0b-49b9-a656-77d71bc30bbd.gdb'
          , 'GI_Inspection'
          , as_tibble = TRUE)


inspection_records <- 
  st_read(  '../GSI STEWARDSHIP Project_data_too_big/50961b03-cb0b-49b9-a656-77d71bc30bbd.gdb'
          , 'GI_Inspection__ATTACH'
          , as_tibble = TRUE)


# take a look
inlet |> glimpse() # transpose
inlet |> mapview(zcol = 'Install_Year')

inspection |> glimpse()

# is the unique ID really unique? 
all.equal(
  inspection |> distinct(GlobalID) |> nrow()
, inspection |> nrow()
)

# short table to long table
inlet |> 
  left_join(inspection_records, by = c('GlobalID' = 'GLOBALID'))

# long table to short table
inspection |> 
  left_join(inlet, by = 'GlobalID')


inlet # GlobalID
inspection # ASSETGUID and GlobalID

# THIS WORKS
inlet |> 
  left_join(inspection, by = c('GlobalID' = 'ASSETGUID'))

(inspection_freq <- 
  inspection |> 
  tabyl(ASSETGUID) |> 
  as_tibble() |> 
  arrange(desc(n)))

# how often have these been inspected?
inspection_freq |> summary() # roughly 4x

# what's the distribution of frequencies?
inspection_freq_freq <- 
  inspection_freq |> 
  tabyl(n) |> 
  as_tibble()

inspection_freq_freq |> plot()

# pre-summarized: geom_col
inspection_freq_freq |> 
  ggplot(aes(n, n_n)) +
  geom_col() +
  theme_bw(16) +
  NULL

# not yet summarized: geom_bar
inspection_freq |> 
  ggplot(aes(n)) +
  # geom_bar() +
  # geom_histogram() +
  geom_density() +
  theme_bw(16) +
  NULL

```




# exploratory
```{r}
gsi |> glimpse()

gsi |> select(GI_Type)

gsi |> 
  st_drop_geometry() |> #removes sticky geometries
  tabyl(file)

gsi |> 
  st_drop_geometry() |> #removes sticky geometries
  tabyl(curb_type, file)

gsi |> 
  st_drop_geometry() |> 
  tabyl(file, Install_Year,Fencing) |> 
  bind_rows(.id = "file") #counts number of GSI that meets the following conditions

gsi |> 
  st_drop_geometry() |> 
  group_by(file, Install_Year, Fencing) |> 
  summarize(n=n()) |> 
  ungroup() #makes as many variables as you want 

gsi |> 
  st_drop_geometry() |> 
  tabyl(Barrier, file)

gsi |> 
  st_drop_geometry() |> 
  tabyl(sidewalk_w, file)


```



```{r}


st_layers('../GSI STEWARDSHIP Project_data_too_big/City_layers.gdb')

thing <- st_read(
  '../GSI STEWARDSHIP Project_data_too_big/City_layers.gdb', 'NH_Publishing_SDE_DBO_NH_2016_Paved_Unpaved_Surfaces_Poly')

thing2 <- st_read(
  '../GSI STEWARDSHIP Project_data_too_big/City_layers.gdb', 'NH_Publishing_SDE_DBO_NH_2016_Structures_Poly')

mapview(thing2)
```





